# 存储器层次结构

存储器系统是一个层次的结构，包括：

- 1.CUP寄存器
- 2.靠近CUP的高速缓存存储器
- 3.主存储器
- 4.磁盘
- 5.通过网络连接的其他设备

每一层都作为下一层的`缓存`区域

## 存储技术

### 随机访问存储器

随机访问存储器（Random-Access Memory RAM）分成两类：静态（SRAM）和动态（DRAM）

- 1.SRAM

SRAM用作`高速缓存存储器`，可以在CPU上也可以在片下，它将每个位存储在一个`双稳态`的存储器单元里，每个单元由`6个晶体管`构成

由于双稳态的特性，只要有电，SRAM就会`永远`保持它的值

通常SRAM不会超过`几兆`字节

- 2.DRAM

DRAM用作`主存`（内存）以及图形系统的帧缓冲区，每个位由`一个晶体管`和`一个电容`构成

DRAM是`不稳定`的，当电容电压被扰乱之后，就不能恢复了

DRAM芯片封装在`内存模块`中，插到主板的扩展槽上，现代内存模块（以Core i7为例）使用240个引脚的`双列直插内存模块`，以64位为块与`内存控制器`互相传输数据

### 非易失性存储器

SRAM和DRAM在断电时会失去信息，他们是易失的

`只读存储器（Read-Only Memory）`是非易失的

根据能够被重编程的次数和重编程的机制将ROM分类：

PROM只能被编程`一次`，可擦写可编程EPROM通过紫外线照射窗口擦除，重编程次数可达1000次，电子可擦除EEORPM能够达到100000次

`闪存`是基于EEPROM的，固态硬盘是基于闪存的


### 磁盘

磁盘由`盘片`构成，每个盘片有两个`表面`，每个表面有一组被称为`磁道`的同心圆组成，每个磁道被划分为一组`扇区`

通常用`柱面`来描述多个盘片驱动器的构造

磁盘用`读/写头`来读写表面上的位，其访问时间主要分为：`寻道时间`、`旋转时间`和`传送时间`，延时主要发生在寻道和旋转延时

磁盘格式化时，会预留一些`备用`的柱面，所以实际的容量会比标称的容量小

- 通用串行总线（Universal Serial Bus USB）

- 内存映射I/O：地址空间中有一块地址是为与I/O设备通信保留的，每个地址称为一个`I/O端口`

- 访问磁盘

    - 1.CPU发起一个磁盘读
    - 2.磁盘读取扇区，并执行向主存的DMA（Direct Memory Access）传送
    - 3.磁盘控制器向CPU发送中断信号来通知CPU传输完成

### 固态硬盘

固态硬盘（Solid State Disk）是基于闪存的存储技术

一个SSD封装由一个或多个`闪存芯片`和`闪存翻译层`组成

一个闪存由多个`块`组成，一个块由多个`页`组成

### 存储器层次结构

上一层是下一层的缓存

每一层的数据被划分成连续的数据对象`块`

第k层的存储器被划分为比k+1层更少的块的集合

当程序需要k+1层的某个对象d时，如果d刚好缓存在第k层中，称为`缓存命中`，否则第k层需要向第k+1层读取，称为`缓存不命中`

当第k层的缓存满时，就需要用k+1层的块`覆盖`现存的一个块，需要由`替换策略`来决定替换哪一个块

### 高速缓存

可以依次划分为`组`、`行`、`块`

尽量使不同元素的地址映射到不同的组中，来避免冲突

替换策略：最不常使用 Least-Frequently Used `LFU`，最近最少使用 Least-Recently Used `LRU`

写缓存时，有两种方法：

- 1.直写，将已经缓存的字w`立即`写到下一层

- 2.写回，尽可能地推迟更新，直到替换算法将要`驱逐`这个块，它能显著地减少总线流量，但实现起来更复杂

#### 层次结构

以Core i7为例，CPU芯片有4个核，每个核有自己`私有的`L1 i-cache（指令缓存）和L2 d-cache（数据缓存）和L2统一高速缓存，所有的核`共享`L3统一的高速缓存

## 局部性

具有局部性的程序倾向于引用`临近于`其它`最近引用过`的数据项的数据项

- 时间局部性：被引用过一次的内存位置可能在不久的将来`再被多次引用`

- 空间局部性：如果一个内存位置被引用了一次，那么程序可能在不久的将来引用`它附近`的一个内存位置

## 链接

链接是将各种代码和数据片段收集并组合成为一个`单一文件`的过程

链接可以执行与`编译时`、`加载时`和`运行时`，通过`链接器`自动执行

c语言编译的过程：源程序`main.c`，ASCII码中间文件`main.i`，ASCII汇编语言文件`main.s`，可重定位目标文件`main.o`，可执行文件`prog`

### 静态链接

静态链接器以一组`可重定位目标文件`和`命令行参数`为输入，生成一个完全链接的、可以加载和运行的`可执行文件`为输出

输入的可重庆薇目标文件由各种不同的`代码`和`数据节`组成

链接器有两个最主要任务：

- 1.符号解析：目标文件中符号对应定义的变量，符号解析的目的是将符号`引用`和符号`定义`关联起来

- 2.重定位：将每个符号定义与一个`内存位置`关联起来
