SPI全称：Serial Peripheral Interface，串行外围设备接口
传输速度很高
全双工

## 物理层
可以一个主机挂载多个从机
有四条线：

- SS：从设备选择信号线（片选信号线、NSS、CS）
  - 每个从设备都有独立的SS线与主机相连，有多少个从设备，主机上就有多少根SS线
  - SPI协议中没有设备地址，通过SS线来选址
  - 当主机要选择某一个从设备时，将这个设备的SS线拉为低电平，该从设备被选中
  - SPI通讯以SS线的低电平为开始，以SS高电平为结束

- SCK：时钟信号线
- MOSI（Master Output,Slave Input)：主设备输出，从设备输入引脚
  - 在这条线上的数据方向为主机到从机

- MISO (Master Input,Slave Output)：主设备输入，从设备输出引脚
  - 在这条线上的数据方向为从机到主机

## 协议层

- SS置为低电平后，开始通信
- 在SCK的上升沿触发数据读取，在SCK的下降沿进行数据采样（可以通过CPOL和CPHA进行设置）
- CPOL：时钟极性，表示通信空闲的时候SCK的电平，当CPOL=0时，空闲时候的SCK为低电平；当CPOL=1时，空闲时候的SCK为高电平
- CPHA：时钟相位，表示采样的时刻，CPHA=0时，在SCK的奇数边沿采样；CPHA=1时，在SCK的偶数边沿采样
- 根据CPOL和CPHA的不同数值，将SPI通讯分成4个模式（00，01，10，11），通讯时主机和从机要在相同模式下

- tips：对于STM32，即使只进行数据读取，也要向数据寄存器写入数据，因为只有写入数据才能触发时钟，SPI外设才会工作

## 关于SPI Flash

存储特性：
- 将内部存储区分块（区），再将每个块再进行细分（扇区）
- 再写入数据之前必须先擦除
- 擦除之后所有数据位都是1
- 在写入的时候只能将已经为1的数据位改成0
- 擦除时必须按最小单位来擦除（一般为扇区），写入时没有限制（norflash的特性）

有一些具体的命令，可以参考官方手册

## 树莓派上的SPI

### 环境配置

- 首先就是像I2C一样需要打开SPI端口，输入`sudo raspi-config`，找到SPI打开它
- 然后输入`lsmod`看到设备里面有`spi_bam2835`就行了（针对树莓派3B+版本）
- 重启`sudo reboot`

### 测试程序

- 如果用Python的话可以使用树莓派自带的`spidev`库，在树莓派3B+上不需要安装
- 或者可以使用`wiringpi for Python`，需要安装，Python3版本的安装方法为`pip3 install wiringpi`
- 我这里用的是spidev，连接的是W25Q64 Flash芯片，向这个芯片写入`0x9f`可以获得三个字节的芯片ID

- tips：在spi接口引脚复用的时候通信会出错
